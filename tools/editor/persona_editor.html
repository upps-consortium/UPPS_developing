<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPPSペルソナエディター</title>
    <style>
        /* CSS Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            
            --border-radius: 8px;
            --box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --transition: all 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-areas: 
                "header header"
                "nav content";
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
            box-shadow: var(--box-shadow);
        }

        /* Header */
        .header {
            grid-area: header;
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn--primary {
            background: white;
            color: var(--primary-color);
        }

        .btn--primary:hover {
            background: var(--bg-tertiary);
        }

        .btn--secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn--secondary:hover {
            background: var(--bg-tertiary);
        }

        /* Navigation */
        .tab-nav {
            grid-area: nav;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1rem 0;
        }

        .tab-btn {
            display: block;
            width: 100%;
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            text-align: left;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--bg-primary);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
            font-weight: 500;
        }

        /* Content Area */
        .content {
            grid-area: content;
            padding: 2rem;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Form Components */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Slider Components */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .slider-input {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            outline: none;
            -webkit-appearance: none;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .slider-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 50px;
            text-align: right;
            font-weight: 500;
            color: var(--primary-color);
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Preview */
        .preview-container {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 500px;
        }

        /* Notifications */
        .notification {
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .notification--success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
            border-left: 4px solid var(--success-color);
        }

        .notification--error {
            background: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border-left: 4px solid var(--error-color);
        }

        .notification--warning {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }

        /* Hidden File Input */
        .file-input {
            display: none;
        }

        /* Association Network Styles */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .associations-table-container {
            overflow-x: auto;
        }

        .associations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .associations-table th,
        .associations-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .associations-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .associations-table td {
            font-size: 0.875rem;
            vertical-align: middle;
        }

        .trigger-display,
        .response-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .trigger-type-icon,
        .response-type-icon {
            font-size: 1.1rem;
        }

        .trigger-details,
        .response-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .strength-bar {
            font-family: monospace;
            font-size: 0.875rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            transition: var(--transition);
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Form Steps */
        .form-steps .step {
            display: none;
        }

        .form-steps .step.active {
            display: block;
        }

        /* Radio Cards */
        .trigger-type-selection {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .radio-card {
            display: block;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .radio-card input[type="radio"] {
            display: none;
        }

        .radio-card:hover {
            border-color: var(--primary-color);
        }

        .radio-card input[type="radio"]:checked + .radio-card-content {
            color: var(--primary-color);
        }

        .radio-card input[type="radio"]:checked {
            border-color: var(--primary-color);
        }

        .radio-card-content strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .radio-card-content small {
            color: var(--text-secondary);
        }

        /* Strength Guide */
        .strength-guide {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            text-align: center;
        }

        /* Trigger Details Forms */
        .external-trigger-form,
        .emotion-trigger-form,
        .memory-trigger-form {
            margin-top: 1rem;
        }

        .trigger-items-input {
            min-height: 80px;
            resize: vertical;
        }

        /* Template Styles */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .template-card {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-primary);
        }

        .template-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .template-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .template-icon {
            font-size: 1.5rem;
        }

        .template-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .template-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .template-preview {
            background: var(--bg-tertiary);
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-family: monospace;
            color: var(--text-secondary);
        }

        .template-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                grid-template-areas: 
                    "header"
                    "nav"
                    "content";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }

            .tab-nav {
                display: flex;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 0;
            }

            .tab-btn {
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }

            .tab-btn.active {
                border-left: none;
                border-bottom-color: var(--primary-color);
            }

            .content {
                padding: 1rem;
            }

            .header-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }

            .header-buttons .btn {
                font-size: 0.75rem;
                padding: 0.375rem 0.75rem;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }

            .associations-table-container {
                font-size: 0.75rem;
            }

            .associations-table th,
            .associations-table td {
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>UPPSペルソナエディター</h1>
            <div class="header-actions">
                <button class="btn btn--primary" onclick="app.handleNewPersona()">
                    ✨ 新規作成
                </button>
                <button class="btn btn--primary" onclick="app.handleLoadFile()">
                    📁 開く
                </button>
                <button class="btn btn--primary" onclick="app.handleSaveFile()">
                    💾 保存
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="personal">
                👤 基本情報
            </button>
            <button class="tab-btn" data-tab="personality">
                🧠 性格特性
            </button>
            <button class="tab-btn" data-tab="emotions">
                😊 感情システム
            </button>
            <button class="tab-btn" data-tab="associations">
                🔗 関連性ネットワーク
            </button>
            <button class="tab-btn" data-tab="preview">
                📄 プレビュー
            </button>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Notifications -->
            <div id="notifications"></div>

            <!-- Personal Info Tab -->
            <div id="personal-tab" class="tab-panel active">
                <div class="card">
                    <h2 class="card-title">基本情報</h2>
                    
                    <div class="form-group">
                        <label for="persona-name">氏名</label>
                        <input type="text" id="persona-name" placeholder="例: 田中太郎" class="persona-input">
                    </div>

                    <div class="form-group">
                        <label for="persona-age">年齢</label>
                        <input type="number" id="persona-age" placeholder="例: 25" min="0" max="150" class="persona-input">
                    </div>

                    <div class="form-group">
                        <label for="persona-gender">性別</label>
                        <select id="persona-gender" class="persona-input">
                            <option value="">選択してください</option>
                            <option value="Male">男性</option>
                            <option value="Female">女性</option>
                            <option value="Other">その他</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="persona-occupation">職業</label>
                        <input type="text" id="persona-occupation" placeholder="例: システムエンジニア" class="persona-input">
                    </div>

                    <div class="form-group">
                        <label for="persona-background">背景情報</label>
                        <textarea id="persona-background" rows="6" 
                                placeholder="成育歴、生活背景の詳細記述を入力してください..." 
                                class="persona-input"></textarea>
                        <div class="form-help">このペルソナの生育歴、教育背景、重要な人生体験などを記述してください。</div>
                    </div>
                </div>
            </div>

            <!-- Personality Tab -->
            <div id="personality-tab" class="tab-panel">
                <div class="card">
                    <h2 class="card-title">BigFive性格特性</h2>
                    
                    <div class="form-group">
                        <label for="openness-slider">開放性 (Openness)</label>
                        <div class="slider-container">
                            <input type="range" id="openness-slider" class="slider-input" min="0" max="100" value="50">
                            <span class="slider-value">50%</span>
                        </div>
                        <div class="form-help">新しい経験や概念への受容性</div>
                    </div>

                    <div class="form-group">
                        <label for="conscientiousness-slider">誠実性 (Conscientiousness)</label>
                        <div class="slider-container">
                            <input type="range" id="conscientiousness-slider" class="slider-input" min="0" max="100" value="50">
                            <span class="slider-value">50%</span>
                        </div>
                        <div class="form-help">計画性や責任感</div>
                    </div>

                    <div class="form-group">
                        <label for="extraversion-slider">外向性 (Extraversion)</label>
                        <div class="slider-container">
                            <input type="range" id="extraversion-slider" class="slider-input" min="0" max="100" value="50">
                            <span class="slider-value">50%</span>
                        </div>
                        <div class="form-help">社交性やエネルギーの外向的発散</div>
                    </div>

                    <div class="form-group">
                        <label for="agreeableness-slider">協調性 (Agreeableness)</label>
                        <div class="slider-container">
                            <input type="range" id="agreeableness-slider" class="slider-input" min="0" max="100" value="50">
                            <span class="slider-value">50%</span>
                        </div>
                        <div class="form-help">他者への思いやりや協力</div>
                    </div>

                    <div class="form-group">
                        <label for="neuroticism-slider">神経症的傾向 (Neuroticism)</label>
                        <div class="slider-container">
                            <input type="range" id="neuroticism-slider" class="slider-input" min="0" max="100" value="50">
                            <span class="slider-value">50%</span>
                        </div>
                        <div class="form-help">感情の不安定さやストレス反応</div>
                    </div>
                </div>
            </div>

            <!-- Emotions Tab -->
            <div id="emotions-tab" class="tab-panel">
                <div class="card">
                    <h2 class="card-title">感情システム (Ekmanモデル)</h2>
                    
                    <div class="form-group">
                        <label for="joy-slider">喜び (Joy)</label>
                        <div class="slider-container">
                            <input type="range" id="joy-slider" class="slider-input" min="0" max="100" value="50">
                            <span class="slider-value">50</span>
                        </div>
                        <div class="form-help">幸福感、満足感</div>
                    </div>

                    <div class="form-group">
                        <label for="sadness-slider">悲しみ (Sadness)</label>
                        <div class="slider-container">
                            <input type="range" id="sadness-slider" class="slider-input" min="0" max="100" value="30">
                            <span class="slider-value">30</span>
                        </div>
                        <div class="form-help">悲しみ、失望感</div>
                    </div>

                    <div class="form-group">
                        <label for="anger-slider">怒り (Anger)</label>
                        <div class="slider-container">
                            <input type="range" id="anger-slider" class="slider-input" min="0" max="100" value="25">
                            <span class="slider-value">25</span>
                        </div>
                        <div class="form-help">怒り、いらだち</div>
                    </div>

                    <div class="form-group">
                        <label for="fear-slider">恐れ (Fear)</label>
                        <div class="slider-container">
                            <input type="range" id="fear-slider" class="slider-input" min="0" max="100" value="40">
                            <span class="slider-value">40</span>
                        </div>
                        <div class="form-help">恐れ、不安</div>
                    </div>

                    <div class="form-group">
                        <label for="disgust-slider">嫌悪 (Disgust)</label>
                        <div class="slider-container">
                            <input type="range" id="disgust-slider" class="slider-input" min="0" max="100" value="20">
                            <span class="slider-value">20</span>
                        </div>
                        <div class="form-help">嫌悪、不快感</div>
                    </div>

                    <div class="form-group">
                        <label for="surprise-slider">驚き (Surprise)</label>
                        <div class="slider-container">
                            <input type="range" id="surprise-slider" class="slider-input" min="0" max="100" value="55">
                            <span class="slider-value">55</span>
                        </div>
                        <div class="form-help">驚き、意外性への反応</div>
                    </div>
                </div>
            </div>

            <!-- Associations Tab -->
            <div id="associations-tab" class="tab-panel">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">関連性ネットワーク</h2>
                        <div class="header-buttons">
                            <button class="btn btn--secondary" onclick="app.openTemplateModal()">
                                📋 テンプレート
                            </button>
                            <button class="btn btn--primary" onclick="app.openAssociationModal()">
                                ➕ 新規追加
                            </button>
                        </div>
                    </div>
                    
                    <!-- 関連性一覧テーブル -->
                    <div class="associations-table-container">
                        <table class="associations-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>トリガー</th>
                                    <th>レスポンス</th>
                                    <th>強度</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="associations-tbody">
                                <!-- JavaScript で動的生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 空の状態 -->
                    <div id="associations-empty" class="empty-state">
                        <p>関連性が設定されていません</p>
                        <button class="btn btn--secondary" onclick="app.openAssociationModal()">
                            最初の関連性を追加
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Tab -->
            <div id="preview-tab" class="tab-panel">
                <div class="card">
                    <h2 class="card-title">YAMLプレビュー</h2>
                    <div id="yaml-preview" class="preview-container">
# ここにYAMLプレビューが表示されます
                    </div>
                </div>
            </div>
        </main>

        <!-- Hidden File Input -->
        <input type="file" id="file-input" class="file-input" accept=".yaml,.yml" />
        
        <!-- Association Edit Modal -->
        <div id="association-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>関連性の編集</h3>
                    <button class="modal-close" onclick="app.closeAssociationModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-steps">
                        <!-- Step 1: Trigger Type Selection -->
                        <div class="step active" data-step="1">
                            <h4>ステップ1: トリガータイプ選択</h4>
                            <div class="trigger-type-selection">
                                <label class="radio-card">
                                    <input type="radio" name="triggerType" value="external">
                                    <div class="radio-card-content">
                                        <strong>🏷️ 外部トリガー</strong>
                                        <small>会話トピックや単語</small>
                                    </div>
                                </label>
                                <label class="radio-card">
                                    <input type="radio" name="triggerType" value="emotion">
                                    <div class="radio-card-content">
                                        <strong>😊 感情トリガー</strong>
                                        <small>感情状態の閾値</small>
                                    </div>
                                </label>
                                <label class="radio-card">
                                    <input type="radio" name="triggerType" value="memory">
                                    <div class="radio-card-content">
                                        <strong>💭 記憶トリガー</strong>
                                        <small>特定の記憶</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Step 2: Trigger Details -->
                        <div class="step" data-step="2">
                            <h4>ステップ2: トリガー詳細設定</h4>
                            <div id="trigger-details">
                                <!-- 選択されたタイプに応じて動的に変更 -->
                            </div>
                        </div>
                        
                        <!-- Step 3: Response Settings -->
                        <div class="step" data-step="3">
                            <h4>ステップ3: レスポンス設定</h4>
                            <div class="form-group">
                                <label for="responseType">レスポンスタイプ</label>
                                <select id="responseType">
                                    <option value="memory">記憶</option>
                                    <option value="emotion">感情</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="responseTarget">対象</label>
                                <select id="responseTarget">
                                    <!-- 選択されたタイプに応じて動的に変更 -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Step 4: Association Strength -->
                        <div class="step" data-step="4">
                            <h4>ステップ4: 関連強度設定</h4>
                            <div class="form-group">
                                <label for="association-strength">関連強度</label>
                                <div class="slider-container">
                                    <input type="range" id="association-strength" 
                                           class="slider-input" min="0" max="100" value="70">
                                    <span class="slider-value">70</span>
                                </div>
                                <div class="strength-guide">
                                    <small>
                                        <strong>0-30:</strong> 弱い関連 |
                                        <strong>31-70:</strong> 中程度 |
                                        <strong>71-100:</strong> 強い関連
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn--secondary" id="prev-step-btn" onclick="app.previousStep()" style="display: none;">← 前へ</button>
                    <button class="btn btn--primary" id="next-step-btn" onclick="app.nextStep()">次へ →</button>
                    <button class="btn btn--success" id="save-association-btn" onclick="app.saveAssociation()" style="display: none;">
                        💾 保存
                    </button>
                    <button class="btn btn--secondary" onclick="app.closeAssociationModal()">キャンセル</button>
                </div>
            </div>
        </div>
        
        <!-- Association Template Modal -->
        <div id="template-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>関連性テンプレート選択</h3>
                    <button class="modal-close" onclick="app.closeTemplateModal()">✕</button>
                </div>
                <div class="modal-body">
                    <p>典型的な関連性パターンから選択して、カスタマイズできます</p>
                    <div class="template-grid" id="template-grid">
                        <!-- JavaScript で動的生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn--secondary" onclick="app.closeTemplateModal()">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- js-yaml CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    
    <script>
        // PersonaData クラス
        class PersonaData {
            constructor() {
                this.data = this.getDefaultData();
            }

            getDefaultData() {
                return {
                    personal_info: {
                        name: "",
                        age: null,
                        gender: "",
                        occupation: ""
                    },
                    background: "",
                    personality: {
                        model: "BigFive",
                        traits: {
                            openness: 0.5,
                            conscientiousness: 0.5,
                            extraversion: 0.5,
                            agreeableness: 0.5,
                            neuroticism: 0.5
                        }
                    },
                    emotion_system: {
                        model: "Ekman",
                        emotions: {
                            joy: { baseline: 50, description: "幸福感、満足感" },
                            sadness: { baseline: 30, description: "悲しみ、失望感" },
                            anger: { baseline: 25, description: "怒り、いらだち" },
                            fear: { baseline: 40, description: "恐れ、不安" },
                            disgust: { baseline: 20, description: "嫌悪、不快感" },
                            surprise: { baseline: 55, description: "驚き、意外性への反応" }
                        }
                    },
                    memory_system: {
                        memories: [
                            {
                                id: "childhood_nature",
                                type: "episodic",
                                content: "子供の頃に森で見つけた珍しい昆虫を観察した経験",
                                period: "Childhood (Age 8)",
                                emotional_valence: "positive",
                                associated_emotions: ["joy", "curiosity"]
                            },
                            {
                                id: "first_research",
                                type: "episodic", 
                                content: "初めて研究論文を発表したときの達成感と緊張",
                                period: "Graduate School (Age 24)",
                                emotional_valence: "positive",
                                associated_emotions: ["joy", "fear"]
                            }
                        ]
                    },
                    association_system: {
                        associations: []
                    }
                };
            }

            getData() {
                return this.data;
            }

            setData(newData) {
                this.data = { ...this.data, ...newData };
                this.notifyChange();
            }

            updatePersonalInfo(info) {
                this.data.personal_info = { ...this.data.personal_info, ...info };
                this.notifyChange();
            }

            updatePersonality(traits) {
                this.data.personality.traits = { ...this.data.personality.traits, ...traits };
                this.notifyChange();
            }

            updateEmotionSystem(emotions) {
                Object.keys(emotions).forEach(emotion => {
                    if (this.data.emotion_system.emotions[emotion]) {
                        this.data.emotion_system.emotions[emotion].baseline = emotions[emotion];
                    }
                });
                this.notifyChange();
            }

            updateBackground(background) {
                this.data.background = background;
                this.notifyChange();
            }

            addAssociation(association) {
                association.id = Date.now(); // 簡易ID生成
                this.data.association_system.associations.push(association);
                this.notifyChange();
            }

            updateAssociation(id, updates) {
                const index = this.data.association_system.associations.findIndex(a => a.id === id);
                if (index !== -1) {
                    this.data.association_system.associations[index] = { 
                        ...this.data.association_system.associations[index], 
                        ...updates 
                    };
                    this.notifyChange();
                }
            }

            deleteAssociation(id) {
                this.data.association_system.associations = 
                    this.data.association_system.associations.filter(a => a.id !== id);
                this.notifyChange();
            }

            getAssociations() {
                return this.data.association_system.associations;
            }

            getMemoryIds() {
                return this.data.memory_system.memories.map(m => m.id).filter(id => id);
            }

            getEmotionIds() {
                const emotions = this.data.emotion_system.emotions;
                const additionalEmotions = this.data.emotion_system.additional_emotions || {};
                return [...Object.keys(emotions), ...Object.keys(additionalEmotions)];
            }

            reset() {
                this.data = this.getDefaultData();
                this.notifyChange();
            }

            toYAML() {
                // 数値を適切な形式に変換
                const outputData = JSON.parse(JSON.stringify(this.data));
                
                // 性格特性を0-1の範囲に変換
                Object.keys(outputData.personality.traits).forEach(trait => {
                    outputData.personality.traits[trait] = outputData.personality.traits[trait] / 100;
                });

                return jsyaml.dump(outputData, {
                    lineWidth: -1,
                    noRefs: true,
                    sortKeys: false
                });
            }

            fromYAML(yamlString) {
                try {
                    const parsedData = jsyaml.load(yamlString);
                    
                    // 性格特性を0-100の範囲に変換
                    if (parsedData.personality && parsedData.personality.traits) {
                        Object.keys(parsedData.personality.traits).forEach(trait => {
                            parsedData.personality.traits[trait] = parsedData.personality.traits[trait] * 100;
                        });
                    }

                    this.data = { ...this.getDefaultData(), ...parsedData };
                    this.notifyChange();
                    return true;
                } catch (error) {
                    console.error('YAML parse error:', error);
                    return false;
                }
            }

            notifyChange() {
                const event = new CustomEvent('personaDataChanged', {
                    detail: { data: this.data }
                });
                document.dispatchEvent(event);
            }
        }

        // UIController クラス
        class UIController {
            constructor(personaData) {
                this.personaData = personaData;
                this.initializeUI();
                this.bindEvents();
            }

            initializeUI() {
                this.updateAllUI();
            }

            bindEvents() {
                // タブ切り替え
                document.addEventListener('click', (e) => {
                    if (e.target.matches('.tab-btn')) {
                        this.showTab(e.target.dataset.tab);
                    }
                });

                // データ変更イベント
                document.addEventListener('input', (e) => {
                    if (e.target.matches('.persona-input')) {
                        this.handlePersonalInfoChange(e);
                    } else if (e.target.matches('.slider-input')) {
                        this.handleSliderChange(e);
                    }
                });

                // データ変更通知を受信
                document.addEventListener('personaDataChanged', () => {
                    this.updateAllUI();
                });
            }

            showTab(tabName) {
                // すべてのタブボタンとパネルを非アクティブに
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

                // 指定されたタブをアクティブに
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.querySelector(`#${tabName}-tab`).classList.add('active');

                // プレビュータブの場合は更新
                if (tabName === 'preview') {
                    this.updatePreview();
                }
            }

            handlePersonalInfoChange(e) {
                const { id, value } = e.target;
                
                if (id === 'persona-name') {
                    this.personaData.updatePersonalInfo({ name: value });
                } else if (id === 'persona-age') {
                    this.personaData.updatePersonalInfo({ age: value ? parseInt(value) : null });
                } else if (id === 'persona-gender') {
                    this.personaData.updatePersonalInfo({ gender: value });
                } else if (id === 'persona-occupation') {
                    this.personaData.updatePersonalInfo({ occupation: value });
                } else if (id === 'persona-background') {
                    this.personaData.updateBackground(value);
                }
            }

            handleSliderChange(e) {
                const { id, value } = e.target;
                const numValue = parseInt(value);

                // スライダー値表示を更新
                const valueDisplay = e.target.parentNode.querySelector('.slider-value');
                
                if (id.includes('-slider')) {
                    const traitName = id.replace('-slider', '');
                    
                    if (['openness', 'conscientiousness', 'extraversion', 'agreeableness', 'neuroticism'].includes(traitName)) {
                        valueDisplay.textContent = numValue + '%';
                        this.personaData.updatePersonality({ [traitName]: numValue });
                    } else if (['joy', 'sadness', 'anger', 'fear', 'disgust', 'surprise'].includes(traitName)) {
                        valueDisplay.textContent = numValue.toString();
                        this.personaData.updateEmotionSystem({ [traitName]: numValue });
                    }
                }
            }

            updateAllUI() {
                const data = this.personaData.getData();
                this.updatePersonalInfoUI(data);
                this.updatePersonalityUI(data);
                this.updateEmotionSystemUI(data);
                this.updateAssociationsUI(data);
            }

            updatePersonalInfoUI(data) {
                document.getElementById('persona-name').value = data.personal_info.name || '';
                document.getElementById('persona-age').value = data.personal_info.age || '';
                document.getElementById('persona-gender').value = data.personal_info.gender || '';
                document.getElementById('persona-occupation').value = data.personal_info.occupation || '';
                document.getElementById('persona-background').value = data.background || '';
            }

            updatePersonalityUI(data) {
                const traits = data.personality.traits;
                Object.keys(traits).forEach(trait => {
                    const slider = document.getElementById(`${trait}-slider`);
                    const valueDisplay = slider.parentNode.querySelector('.slider-value');
                    slider.value = traits[trait];
                    valueDisplay.textContent = Math.round(traits[trait]) + '%';
                });
            }

            updateEmotionSystemUI(data) {
                const emotions = data.emotion_system.emotions;
                Object.keys(emotions).forEach(emotion => {
                    const slider = document.getElementById(`${emotion}-slider`);
                    const valueDisplay = slider.parentNode.querySelector('.slider-value');
                    slider.value = emotions[emotion].baseline;
                    valueDisplay.textContent = emotions[emotion].baseline.toString();
                });
            }

            updateAssociationsUI(data) {
                const associations = data.association_system.associations;
                const tbody = document.getElementById('associations-tbody');
                const emptyState = document.getElementById('associations-empty');
                
                if (associations.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.innerHTML = associations.map((assoc, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${this.renderTrigger(assoc.trigger)}</td>
                        <td>${this.renderResponse(assoc.response)}</td>
                        <td>${this.renderStrength(assoc.response.association_strength)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="app.editAssociation(${assoc.id})" title="編集">
                                    ✏️
                                </button>
                                <button class="btn-icon" onclick="app.deleteAssociation(${assoc.id})" title="削除">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            renderTrigger(trigger) {
                if (trigger.type === 'external') {
                    const items = trigger.items ? trigger.items.slice(0, 3).join(', ') : '';
                    const more = trigger.items && trigger.items.length > 3 ? '...' : '';
                    return `
                        <div class="trigger-display">
                            <span class="trigger-type-icon">🏷️</span>
                            <div>
                                <div class="trigger-details">[${items}${more}]</div>
                            </div>
                        </div>
                    `;
                } else if (trigger.type === 'emotion') {
                    return `
                        <div class="trigger-display">
                            <span class="trigger-type-icon">😊</span>
                            <div>
                                <div>${trigger.id}</div>
                                <div class="trigger-details">≥ ${trigger.threshold}</div>
                            </div>
                        </div>
                    `;
                } else if (trigger.type === 'memory') {
                    return `
                        <div class="trigger-display">
                            <span class="trigger-type-icon">💭</span>
                            <div>
                                <div>${trigger.id}</div>
                            </div>
                        </div>
                    `;
                }
                return 'Unknown';
            }

            renderResponse(response) {
                const icon = response.type === 'memory' ? '💭' : '😊';
                return `
                    <div class="response-display">
                        <span class="response-type-icon">${icon}</span>
                        <div>${response.id}</div>
                    </div>
                `;
            }

            renderStrength(strength) {
                const bars = Math.floor(strength / 10);
                const filled = '■'.repeat(bars);
                const empty = '□'.repeat(10 - bars);
                return `<div class="strength-bar">${filled}${empty} ${strength}</div>`;
            }

            updatePreview() {
                const yamlContent = this.personaData.toYAML();
                document.getElementById('yaml-preview').textContent = yamlContent;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification notification--${type}`;
                notification.textContent = message;
                
                const container = document.getElementById('notifications');
                container.appendChild(notification);

                setTimeout(() => {
                    container.removeChild(notification);
                }, 5000);
            }
        }

        // FileHandler クラス
        class FileHandler {
            constructor(personaData, uiController) {
                this.personaData = personaData;
                this.uiController = uiController;
            }

            async loadFile() {
                return new Promise((resolve) => {
                    const input = document.getElementById('file-input');
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const content = e.target.result;
                                if (this.personaData.fromYAML(content)) {
                                    this.uiController.showNotification('ファイルを正常に読み込みました', 'success');
                                    resolve(true);
                                } else {
                                    this.uiController.showNotification('ファイルの読み込みに失敗しました', 'error');
                                    resolve(false);
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    input.click();
                });
            }

            saveFile(filename = 'persona.yaml') {
                const yamlContent = this.personaData.toYAML();
                const blob = new Blob([yamlContent], { type: 'text/yaml' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                this.uiController.showNotification('ファイルを保存しました', 'success');
            }
        }

        // App クラス
        class App {
            constructor() {
                this.personaData = new PersonaData();
                this.uiController = new UIController(this.personaData);
                this.fileHandler = new FileHandler(this.personaData, this.uiController);
                this.currentStep = 1;
                this.editingAssociationId = null;
                this.associationFormData = {};
                this.initializeAssociationModal();
                this.initializeTemplates();
            }

            initializeAssociationModal() {
                // ラジオボタンの変更を監視
                document.addEventListener('change', (e) => {
                    if (e.target.name === 'triggerType') {
                        this.updateTriggerDetails(e.target.value);
                    } else if (e.target.id === 'responseType') {
                        this.updateResponseTargets(e.target.value);
                    }
                });

                // 関連強度スライダーの監視
                document.addEventListener('input', (e) => {
                    if (e.target.id === 'association-strength') {
                        const valueDisplay = e.target.parentNode.querySelector('.slider-value');
                        valueDisplay.textContent = e.target.value;
                    }
                });

                // モーダル背景クリックで閉じる
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'association-modal') {
                        this.closeAssociationModal();
                    }
                    if (e.target.id === 'template-modal') {
                        this.closeTemplateModal();
                    }
                });
            }

            initializeTemplates() {
                this.templates = [
                    {
                        id: 'trauma_memory',
                        icon: '⚠️',
                        title: 'トラウマ的記憶',
                        description: '特定の話題が不安や恐怖感情を引き起こす関連性',
                        category: 'ネガティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['事故', '病院', '痛み']
                            },
                            response: {
                                type: 'emotion',
                                id: 'fear',
                                association_strength: 85
                            }
                        }
                    },
                    {
                        id: 'warm_childhood',
                        icon: '🌸',
                        title: 'ほのぼのした思い出',
                        description: '子供時代の温かい記憶が喜びの感情を呼び起こす',
                        category: 'ポジティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['子供時代', '家族', '遊び']
                            },
                            response: {
                                type: 'emotion',
                                id: 'joy',
                                association_strength: 75
                            }
                        }
                    },
                    {
                        id: 'achievement_pride',
                        icon: '🏆',
                        title: '達成体験',
                        description: '成功や達成の話題が誇りや自信を呼び起こす',
                        category: 'ポジティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['成功', '達成', '賞']
                            },
                            response: {
                                type: 'emotion',
                                id: 'joy',
                                association_strength: 80
                            }
                        }
                    },
                    {
                        id: 'failure_shame',
                        icon: '😞',
                        title: '失敗体験',
                        description: '失敗や挫折の話題が恥ずかしさや悲しみを引き起こす',
                        category: 'ネガティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['失敗', '挫折', 'ミス']
                            },
                            response: {
                                type: 'emotion',
                                id: 'sadness',
                                association_strength: 70
                            }
                        }
                    },
                    {
                        id: 'nature_peace',
                        icon: '🌲',
                        title: '自然への愛着',
                        description: '自然に関する話題が平穏や喜びをもたらす',
                        category: 'ポジティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['自然', '森', '山', '海']
                            },
                            response: {
                                type: 'emotion',
                                id: 'joy',
                                association_strength: 65
                            }
                        }
                    },
                    {
                        id: 'social_anxiety',
                        icon: '😰',
                        title: '社交不安',
                        description: '人との接触や評価場面で不安が高まる',
                        category: 'ネガティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['発表', '人前', '評価', '視線']
                            },
                            response: {
                                type: 'emotion',
                                id: 'fear',
                                association_strength: 80
                            }
                        }
                    },
                    {
                        id: 'art_inspiration',
                        icon: '🎨',
                        title: '芸術的感性',
                        description: '芸術や美に触れると感動や創造性が湧く',
                        category: 'ポジティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['音楽', '絵画', '詩', '美']
                            },
                            response: {
                                type: 'emotion',
                                id: 'surprise',
                                association_strength: 70
                            }
                        }
                    },
                    {
                        id: 'loss_grief',
                        icon: '💔',
                        title: '喪失体験',
                        description: '別れや喪失の話題が深い悲しみを呼び起こす',
                        category: 'ネガティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['別れ', '死', '喪失', 'さよなら']
                            },
                            response: {
                                type: 'emotion',
                                id: 'sadness',
                                association_strength: 90
                            }
                        }
                    },
                    {
                        id: 'learning_curiosity',
                        icon: '📚',
                        title: '学習への興味',
                        description: '知識や学習の話題が好奇心を刺激する',
                        category: 'ポジティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['学習', '知識', '発見', '研究']
                            },
                            response: {
                                type: 'emotion',
                                id: 'surprise',
                                association_strength: 75
                            }
                        }
                    },
                    {
                        id: 'injustice_anger',
                        icon: '😠',
                        title: '不公平への憤り',
                        description: '不公平や不正の話題が怒りを引き起こす',
                        category: 'ネガティブ',
                        template: {
                            trigger: {
                                type: 'external',
                                category: 'topics',
                                items: ['不公平', '不正', '差別', 'いじめ']
                            },
                            response: {
                                type: 'emotion',
                                id: 'anger',
                                association_strength: 85
                            }
                        }
                    }
                ];
            }

            handleNewPersona() {
                if (confirm('新しいペルソナを作成します。現在の内容は失われますがよろしいですか？')) {
                    this.personaData.reset();
                    this.uiController.showNotification('新しいペルソナを作成しました', 'success');
                }
            }

            async handleLoadFile() {
                await this.fileHandler.loadFile();
            }

            handleSaveFile() {
                const personaName = this.personaData.getData().personal_info.name;
                const filename = personaName ? `${personaName.replace(/\s+/g, '_')}.yaml` : 'persona.yaml';
                this.fileHandler.saveFile(filename);
            }

            // 関連性ネットワーク編集メソッド
            openAssociationModal(associationId = null) {
                this.editingAssociationId = associationId;
                this.currentStep = 1;
                this.associationFormData = {};
                
                // モーダル表示
                const modal = document.getElementById('association-modal');
                modal.classList.add('show');
                
                // フォームリセット
                this.resetAssociationForm();
                this.updateStepDisplay();
                
                if (associationId) {
                    // 編集モードの場合、既存データを読み込み
                    this.loadAssociationData(associationId);
                }
            }

            closeAssociationModal() {
                const modal = document.getElementById('association-modal');
                modal.classList.remove('show');
                this.resetAssociationForm();
            }

            resetAssociationForm() {
                // ラジオボタンリセット
                document.querySelectorAll('input[name="triggerType"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // トリガー詳細クリア
                document.getElementById('trigger-details').innerHTML = '';
                
                // レスポンス設定リセット
                document.getElementById('responseType').value = 'memory';
                document.getElementById('responseTarget').innerHTML = '';
                
                // 関連強度リセット
                document.getElementById('association-strength').value = 70;
                document.querySelector('#association-strength').parentNode.querySelector('.slider-value').textContent = '70';
                
                this.currentStep = 1;
                this.updateStepDisplay();
            }

            updateStepDisplay() {
                // ステップ表示切り替え
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active');
                });
                document.querySelector(`[data-step="${this.currentStep}"]`).classList.add('active');
                
                // ボタン表示制御
                const prevBtn = document.getElementById('prev-step-btn');
                const nextBtn = document.getElementById('next-step-btn');
                const saveBtn = document.getElementById('save-association-btn');
                
                prevBtn.style.display = this.currentStep > 1 ? 'block' : 'none';
                nextBtn.style.display = this.currentStep < 4 ? 'block' : 'none';
                saveBtn.style.display = this.currentStep === 4 ? 'block' : 'none';
            }

            nextStep() {
                if (this.validateCurrentStep()) {
                    this.saveCurrentStepData();
                    if (this.currentStep < 4) {
                        this.currentStep++;
                        this.updateStepDisplay();
                        
                        if (this.currentStep === 3) {
                            this.updateResponseTargets(document.getElementById('responseType').value);
                        }
                    }
                }
            }

            previousStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateStepDisplay();
                }
            }

            validateCurrentStep() {
                switch (this.currentStep) {
                    case 1:
                        const triggerType = document.querySelector('input[name="triggerType"]:checked');
                        if (!triggerType) {
                            this.uiController.showNotification('トリガータイプを選択してください', 'warning');
                            return false;
                        }
                        return true;
                    case 2:
                        return this.validateTriggerDetails();
                    case 3:
                        const responseTarget = document.getElementById('responseTarget').value;
                        if (!responseTarget) {
                            this.uiController.showNotification('レスポンス対象を選択してください', 'warning');
                            return false;
                        }
                        return true;
                    default:
                        return true;
                }
            }

            validateTriggerDetails() {
                const triggerType = this.associationFormData.triggerType;
                
                if (triggerType === 'external') {
                    const items = document.getElementById('external-items')?.value;
                    if (!items || !items.trim()) {
                        this.uiController.showNotification('トリガーワードを入力してください', 'warning');
                        return false;
                    }
                } else if (triggerType === 'emotion') {
                    const emotionTarget = document.getElementById('emotion-target')?.value;
                    if (!emotionTarget) {
                        this.uiController.showNotification('対象感情を選択してください', 'warning');
                        return false;
                    }
                } else if (triggerType === 'memory') {
                    const memoryTarget = document.getElementById('memory-target')?.value;
                    if (!memoryTarget) {
                        this.uiController.showNotification('対象記憶を選択してください', 'warning');
                        return false;
                    }
                }
                
                return true;
            }

            saveCurrentStepData() {
                switch (this.currentStep) {
                    case 1:
                        this.associationFormData.triggerType = document.querySelector('input[name="triggerType"]:checked').value;
                        break;
                    case 2:
                        this.saveTriggerDetails();
                        break;
                    case 3:
                        this.associationFormData.responseType = document.getElementById('responseType').value;
                        this.associationFormData.responseTarget = document.getElementById('responseTarget').value;
                        break;
                    case 4:
                        this.associationFormData.associationStrength = parseInt(document.getElementById('association-strength').value);
                        break;
                }
            }

            saveTriggerDetails() {
                const triggerType = this.associationFormData.triggerType;
                
                if (triggerType === 'external') {
                    const category = document.getElementById('external-category')?.value || 'topics';
                    const items = document.getElementById('external-items').value
                        .split(',').map(item => item.trim()).filter(item => item);
                    
                    this.associationFormData.trigger = {
                        type: 'external',
                        category: category,
                        items: items
                    };
                } else if (triggerType === 'emotion') {
                    const emotionId = document.getElementById('emotion-target').value;
                    const threshold = parseInt(document.getElementById('emotion-threshold').value);
                    
                    this.associationFormData.trigger = {
                        type: 'emotion',
                        id: emotionId,
                        threshold: threshold
                    };
                } else if (triggerType === 'memory') {
                    const memoryId = document.getElementById('memory-target').value;
                    
                    this.associationFormData.trigger = {
                        type: 'memory',
                        id: memoryId
                    };
                }
            }

            updateTriggerDetails(triggerType) {
                const container = document.getElementById('trigger-details');
                
                if (triggerType === 'external') {
                    container.innerHTML = `
                        <div class="external-trigger-form">
                            <div class="form-group">
                                <label for="external-category">カテゴリ</label>
                                <select id="external-category">
                                    <option value="topics">トピック・単語</option>
                                    <option value="interaction_quality">対話の雰囲気</option>
                                    <option value="context">文脈情報</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="external-items">トリガーワード（カンマ区切り）</label>
                                <textarea id="external-items" class="trigger-items-input" 
                                         placeholder="例: nature, forest, insects"></textarea>
                                <div class="form-help">
                                    会話中にこれらの単語が出現したときにトリガーされます
                                </div>
                            </div>
                        </div>
                    `;
                } else if (triggerType === 'emotion') {
                    const emotionIds = this.personaData.getEmotionIds();
                    const emotionOptions = emotionIds.map(id => 
                        `<option value="${id}">${id}</option>`
                    ).join('');
                    
                    container.innerHTML = `
                        <div class="emotion-trigger-form">
                            <div class="form-group">
                                <label for="emotion-target">対象感情</label>
                                <select id="emotion-target">
                                    <option value="">選択してください</option>
                                    ${emotionOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="emotion-threshold">閾値</label>
                                <div class="slider-container">
                                    <input type="range" id="emotion-threshold" 
                                           class="slider-input" min="0" max="100" value="60">
                                    <span class="slider-value">60</span>
                                </div>
                                <div class="form-help">
                                    この値以上になったときにトリガーされます
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 閾値スライダーのイベントリスナー追加
                    document.getElementById('emotion-threshold').addEventListener('input', (e) => {
                        e.target.parentNode.querySelector('.slider-value').textContent = e.target.value;
                    });
                } else if (triggerType === 'memory') {
                    const memoryIds = this.personaData.getMemoryIds();
                    const memoryOptions = memoryIds.map(id => 
                        `<option value="${id}">${id}</option>`
                    ).join('');
                    
                    container.innerHTML = `
                        <div class="memory-trigger-form">
                            <div class="form-group">
                                <label for="memory-target">対象記憶</label>
                                <select id="memory-target">
                                    <option value="">選択してください</option>
                                    ${memoryOptions}
                                </select>
                            </div>
                            <div class="form-help">
                                この記憶が想起されたときにトリガーされます
                            </div>
                        </div>
                    `;
                }
            }

            updateResponseTargets(responseType) {
                const select = document.getElementById('responseTarget');
                
                if (responseType === 'memory') {
                    const memoryIds = this.personaData.getMemoryIds();
                    select.innerHTML = '<option value="">選択してください</option>' +
                        memoryIds.map(id => `<option value="${id}">${id}</option>`).join('');
                } else if (responseType === 'emotion') {
                    const emotionIds = this.personaData.getEmotionIds();
                    select.innerHTML = '<option value="">選択してください</option>' +
                        emotionIds.map(id => `<option value="${id}">${id}</option>`).join('');
                }
            }

            saveAssociation() {
                this.saveCurrentStepData();
                
                const association = {
                    trigger: this.associationFormData.trigger,
                    response: {
                        type: this.associationFormData.responseType,
                        id: this.associationFormData.responseTarget,
                        association_strength: this.associationFormData.associationStrength
                    }
                };
                
                if (this.editingAssociationId) {
                    this.personaData.updateAssociation(this.editingAssociationId, association);
                    this.uiController.showNotification('関連性を更新しました', 'success');
                } else {
                    this.personaData.addAssociation(association);
                    this.uiController.showNotification('関連性を追加しました', 'success');
                }
                
                this.closeAssociationModal();
            }

            editAssociation(id) {
                this.openAssociationModal(id);
            }

            deleteAssociation(id) {
                if (confirm('この関連性を削除しますか？')) {
                    this.personaData.deleteAssociation(id);
                    this.uiController.showNotification('関連性を削除しました', 'success');
                }
            }

            loadAssociationData(id) {
                const associations = this.personaData.getAssociations();
                const association = associations.find(a => a.id === id);
                
                if (association) {
                    // TODO: 編集モードでの既存データ読み込み実装
                    console.log('Loading association for edit:', association);
                }
            }

            // テンプレート関連メソッド
            openTemplateModal() {
                const modal = document.getElementById('template-modal');
                modal.classList.add('show');
                this.renderTemplateGrid();
            }

            closeTemplateModal() {
                const modal = document.getElementById('template-modal');
                modal.classList.remove('show');
            }

            renderTemplateGrid() {
                const grid = document.getElementById('template-grid');
                grid.innerHTML = this.templates.map(template => `
                    <div class="template-card" onclick="app.selectTemplate('${template.id}')">
                        <div class="template-card-header">
                            <span class="template-icon">${template.icon}</span>
                            <span class="template-title">${template.title}</span>
                        </div>
                        <div class="template-description">
                            ${template.description}
                        </div>
                        <div class="template-preview">
                            ${this.getTemplatePreview(template.template)}
                        </div>
                        <div class="template-tag">${template.category}</div>
                    </div>
                `).join('');
            }

            getTemplatePreview(template) {
                const trigger = template.trigger;
                const response = template.response;
                
                let triggerText = '';
                if (trigger.type === 'external') {
                    triggerText = `🏷️ [${trigger.items.slice(0, 2).join(', ')}...]`;
                } else if (trigger.type === 'emotion') {
                    triggerText = `😊 ${trigger.id} ≥ ${trigger.threshold}`;
                } else if (trigger.type === 'memory') {
                    triggerText = `💭 ${trigger.id}`;
                }
                
                const responseIcon = response.type === 'memory' ? '💭' : '😊';
                const responseText = `${responseIcon} ${response.id}`;
                
                return `${triggerText} → ${responseText} (${response.association_strength})`;
            }

            selectTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (template) {
                    this.closeTemplateModal();
                    this.applyTemplate(template.template);
                }
            }

            applyTemplate(template) {
                // テンプレートを関連性フォームに適用
                this.openAssociationModal();
                
                // ステップ1: トリガータイプを設定
                setTimeout(() => {
                    const triggerTypeRadio = document.querySelector(`input[name="triggerType"][value="${template.trigger.type}"]`);
                    if (triggerTypeRadio) {
                        triggerTypeRadio.checked = true;
                        this.updateTriggerDetails(template.trigger.type);
                        
                        // トリガー詳細を設定
                        setTimeout(() => {
                            this.fillTriggerDetails(template.trigger);
                        }, 100);
                    }
                    
                    // レスポンス設定
                    setTimeout(() => {
                        const responseTypeSelect = document.getElementById('responseType');
                        const associationStrengthSlider = document.getElementById('association-strength');
                        
                        if (responseTypeSelect) {
                            responseTypeSelect.value = template.response.type;
                            this.updateResponseTargets(template.response.type);
                            
                            setTimeout(() => {
                                const responseTargetSelect = document.getElementById('responseTarget');
                                if (responseTargetSelect) {
                                    responseTargetSelect.value = template.response.id;
                                }
                            }, 50);
                        }
                        
                        if (associationStrengthSlider) {
                            associationStrengthSlider.value = template.response.association_strength;
                            associationStrengthSlider.parentNode.querySelector('.slider-value').textContent = template.response.association_strength;
                        }
                    }, 150);
                }, 100);
                
                // フォームデータに保存
                this.associationFormData = {
                    triggerType: template.trigger.type,
                    trigger: template.trigger,
                    responseType: template.response.type,
                    responseTarget: template.response.id,
                    associationStrength: template.response.association_strength
                };
                
                // 通知
                this.uiController.showNotification('テンプレートを適用しました。各ステップで内容を確認・調整して保存してください。', 'success');
            }

            fillTriggerDetails(trigger) {
                if (trigger.type === 'external') {
                    const categorySelect = document.getElementById('external-category');
                    const itemsTextarea = document.getElementById('external-items');
                    
                    if (categorySelect && trigger.category) {
                        categorySelect.value = trigger.category;
                    }
                    if (itemsTextarea && trigger.items) {
                        itemsTextarea.value = trigger.items.join(', ');
                    }
                } else if (trigger.type === 'emotion') {
                    const emotionSelect = document.getElementById('emotion-target');
                    const thresholdSlider = document.getElementById('emotion-threshold');
                    
                    if (emotionSelect && trigger.id) {
                        emotionSelect.value = trigger.id;
                    }
                    if (thresholdSlider && trigger.threshold) {
                        thresholdSlider.value = trigger.threshold;
                        thresholdSlider.parentNode.querySelector('.slider-value').textContent = trigger.threshold;
                    }
                } else if (trigger.type === 'memory') {
                    const memorySelect = document.getElementById('memory-target');
                    
                    if (memorySelect && trigger.id) {
                        memorySelect.value = trigger.id;
                    }
                }
            }
        }

        // アプリケーション初期化
        const app = new App();
    </script>
</body>
</html>
