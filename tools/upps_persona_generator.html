<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§  UPPS ãƒšãƒ«ã‚½ãƒŠè‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 24px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            color: white;
            text-align: center;
            line-height: 24px;
            font-size: 0.9rem;
        }

        .result-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .result-item h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .result-item .score {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .score.success {
            color: #28a745;
        }

        .score.warning {
            color: #ffc107;
        }

        .score.error {
            color: #dc3545;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .file-drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 1px solid #dee2e6;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  UPPS ãƒšãƒ«ã‚½ãƒŠè‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>CSVå½¢å¼ã®åˆ¶ç´„æ¡ä»¶ã‹ã‚‰è¤‡æ•°ã®UPPS 2025.2æº–æ‹ ãƒšãƒ«ã‚½ãƒŠã‚’è‡ªå‹•ç”Ÿæˆ</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('setup')">âš™ï¸ è¨­å®š</button>
            <button class="tab" onclick="showTab('files')">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«</button>
            <button class="tab" onclick="showTab('templates')">ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</button>
            <button class="tab" onclick="showTab('generate')">ğŸš€ ç”Ÿæˆ</button>
            <button class="tab" onclick="showTab('results')">ğŸ“Š çµæœ</button>
        </div>

        <!-- è¨­å®šã‚¿ãƒ– -->
        <div id="setup" class="tab-content active">
            <h2>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
            
            <div class="alert alert-info">
                â„¹ï¸ <strong>æ³¨æ„:</strong> è¨­å®šã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨è¨­å®šã¯æ¶ˆå»ã•ã‚Œã¾ã™ã€‚
            </div>
            
            <div class="form-group">
                <label for="apiKey">OpenAI API Key *</label>
                <input type="password" id="apiKey" placeholder="sk-..." required>
                <small style="color: #6c757d;">APIã‚­ãƒ¼ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</small>
            </div>

            <div class="two-column">
                <div class="form-group">
                    <label for="targetScore">ç›®æ¨™å“è³ªã‚¹ã‚³ã‚¢</label>
                    <select id="targetScore">
                        <option value="70">70ç‚¹ï¼ˆåŸºæœ¬ï¼‰</option>
                        <option value="80" selected>80ç‚¹ï¼ˆæ¨™æº–ï¼‰</option>
                        <option value="90">90ç‚¹ï¼ˆé«˜å“è³ªï¼‰</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="maxIterations">æœ€å¤§åå¾©å›æ•°</label>
                    <select id="maxIterations">
                        <option value="1">1å›</option>
                        <option value="2">2å›</option>
                        <option value="3" selected>3å›</option>
                        <option value="5">5å›</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            <div id="settingsAlert"></div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ– -->
        <div id="files" class="tab-content">
            <h2>ğŸ“ åˆ¶ç´„æ¡ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h2>
            
            <div class="alert alert-info">
                â„¹ï¸ <strong>æ³¨æ„:</strong> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿ä¿æŒã•ã‚Œã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆå»ã•ã‚Œã¾ã™ã€‚
            </div>
            
            <h3>ã‚µãƒ³ãƒ—ãƒ«CSVãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <p>ä»¥ä¸‹ã®å½¢å¼ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¦ãã ã•ã„ï¼š</p>
            
            <div class="code-block">id,constraints
persona_001,"25æ­³æ—¥æœ¬äººç”·æ€§ã€ç¤¾äº¤ä¸å®‰éšœå®³ã€ITé–¢é€£è·ã€å®Œç’§ä¸»ç¾©çš„å‚¾å‘"
persona_002,"30ä»£å¥³æ€§ã€ã†ã¤ç—…ã€å…ƒçœ‹è­·å¸«ã€2å…ã®æ¯"
persona_003,"40ä»£ç”·æ€§ã€PTSDã€å…ƒè‡ªè¡›å®˜ã€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ä¾å­˜ç—‡ä½µç™º"</div>
            
            <button class="btn btn-secondary" onclick="downloadSampleCSV()">ğŸ“¥ ã‚µãƒ³ãƒ—ãƒ«CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

            <h3 style="margin-top: 30px;">åˆ¶ç´„æ¡ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div class="file-drop-zone" onclick="document.getElementById('csvFile').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <p>ğŸ“„ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="loadCSVFile(event)">
            </div>
            
            <div id="fileInfo"></div>
            <div id="csvPreview"></div>
        </div>

        <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ãƒ– -->
        <div id="templates" class="tab-content">
            <h2>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†</h2>
            
            <div class="two-column">
                <div>
                    <h3>ğŸ¯ ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                    <div class="form-group">
                        <textarea id="generationTemplate" style="min-height: 400px;"></textarea>
                        <small style="color: #6c757d;">åˆ¶ç´„æ¡ä»¶: {constraints}, åå¾©å›æ•°: {iteration}</small>
                    </div>
                </div>
                
                <div>
                    <h3>ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                    <div class="form-group">
                        <textarea id="qualityTemplate" style="min-height: 400px;"></textarea>
                        <small style="color: #6c757d;">ãƒšãƒ«ã‚½ãƒŠ: {persona_draft}, åˆ¶ç´„æ¡ä»¶: {constraints}</small>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveTemplates()">ğŸ’¾ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜</button>
            <button class="btn btn-secondary" onclick="resetTemplates()">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            <div id="templateAlert"></div>
        </div>

        <!-- ç”Ÿæˆã‚¿ãƒ– -->
        <div id="generate" class="tab-content">
            <h2>ğŸš€ ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆå®Ÿè¡Œ</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalConstraints">0</div>
                    <div class="stat-label">åˆ¶ç´„æ¡ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="targetScoreDisplay">80</div>
                    <div class="stat-label">ç›®æ¨™ã‚¹ã‚³ã‚¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="maxIterDisplay">3</div>
                    <div class="stat-label">æœ€å¤§åå¾©å›æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="estimatedCost">$0</div>
                    <div class="stat-label">æ¨å®šã‚³ã‚¹ãƒˆ</div>
                </div>
            </div>

            <div id="generateAlert"></div>
            
            <button class="btn btn-primary" onclick="startGeneration()" id="generateBtn">ğŸš€ ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆé–‹å§‹</button>
            <button class="btn btn-secondary hidden" onclick="stopGeneration()" id="stopBtn">â¹ï¸ ç”Ÿæˆåœæ­¢</button>
            
            <div id="progressContainer" class="hidden">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
                </div>
                <div id="progressText"></div>
            </div>
            
            <div id="generationLog"></div>
        </div>

        <!-- çµæœã‚¿ãƒ– -->
        <div id="results" class="tab-content">
            <h2>ğŸ“Š ç”Ÿæˆçµæœ</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalProcessed">0</div>
                    <div class="stat-label">ç·å‡¦ç†æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successCount">0</div>
                    <div class="stat-label">æˆåŠŸ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="partialCount">0</div>
                    <div class="stat-label">éƒ¨åˆ†æˆåŠŸ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="errorCount">0</div>
                    <div class="stat-label">ã‚¨ãƒ©ãƒ¼</div>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="downloadAllResults()">ğŸ’¾ å…¨çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-secondary" onclick="downloadSummaryCSV()">ğŸ“Š ã‚µãƒãƒªãƒ¼CSV</button>
            
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆlocalStorageä»£æ›¿ï¼‰
        let constraints = [];
        let results = [];
        let isGenerating = false;
        let currentIndex = 0;
        
        // è¨­å®šã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ¡ãƒ¢ãƒªã«ä¿å­˜
        let settings = {
            apiKey: '',
            targetScore: 80,
            maxIterations: 3
        };
        
        let templates = {
            generation: '',
            quality: ''
        };

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        const defaultGenerationTemplate = `# UPPS 2025.2 ãƒšãƒ«ã‚½ãƒŠç”ŸæˆæŒ‡ç¤º

ã‚ãªãŸã¯UPPSï¼ˆUnified Personality Profile Standardï¼‰2025.2ã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®åˆ¶ç´„æ¡ä»¶ã«åŸºã¥ã„ã¦ã€å®Œå…¨ãªãƒšãƒ«ã‚½ãƒŠã‚’YAMLå½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## UPPS 2025.2 è¦æ ¼æ¦‚è¦
- å¯¾è©±å‹AIã‚„æ¶ç©ºã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®äººæ ¼ãƒ¢ãƒ‡ãƒ«æ¨™æº–åŒ–ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- BigFiveç†è«–ã«ã‚ˆã‚‹æ€§æ ¼ç‰¹æ€§
- æ„Ÿæƒ…ã‚·ã‚¹ãƒ†ãƒ ï¼ˆEkman ãƒ¢ãƒ‡ãƒ«æ¨å¥¨ï¼‰
- è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ ï¼ˆepisodic/semantic/proceduralï¼‰
- é–¢é€£æ€§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆæ„Ÿæƒ…ã¨è¨˜æ†¶ã®ç›¸äº’ä½œç”¨ï¼‰
- èªçŸ¥èƒ½åŠ›ã‚·ã‚¹ãƒ†ãƒ ï¼ˆWAIS-IVæº–æ‹ ï¼‰

## å¿…é ˆæ§‹é€ 
\`\`\`yaml
personal_info:
  name: "æ°å"
  age: å¹´é½¢
  gender: "æ€§åˆ¥"
  occupation: "è·æ¥­"

background: |
  æˆè‚²æ­´ãƒ»ç”Ÿæ´»èƒŒæ™¯ã®è©³ç´°è¨˜è¿°

personality:
  model: "BigFive"
  traits:
    openness: 0.0-1.0
    conscientiousness: 0.0-1.0
    extraversion: 0.0-1.0
    agreeableness: 0.0-1.0
    neuroticism: 0.0-1.0

emotion_system:
  model: "Ekman"
  emotions:
    joy: {baseline: 0-100, description: "èª¬æ˜"}
    sadness: {baseline: 0-100, description: "èª¬æ˜"}
    anger: {baseline: 0-100, description: "èª¬æ˜"}
    fear: {baseline: 0-100, description: "èª¬æ˜"}
    disgust: {baseline: 0-100, description: "èª¬æ˜"}
    surprise: {baseline: 0-100, description: "èª¬æ˜"}

memory_system:
  memories:
    - id: "memory_id"
      type: "episodic"
      content: "è¨˜æ†¶å†…å®¹"
      period: "æ™‚æœŸ"
      associated_emotions: ["é–¢é€£æ„Ÿæƒ…"]

association_system:
  associations:
    - trigger:
        type: "external"
        category: "topics"
        items: ["ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰"]
      response:
        type: "memory"
        id: "memory_id"
        association_strength: 0-100

cognitive_system:
  model: "WAIS-IV"
  abilities:
    verbal_comprehension:
      level: 0-100
    perceptual_reasoning:
      level: 0-100
    working_memory:
      level: 0-100
    processing_speed:
      level: 0-100
\`\`\`

## åˆ¶ç´„æ¡ä»¶
{constraints}

## ç”Ÿæˆè¦ä»¶
1. åŒ»å­¦çš„ãƒ»å¿ƒç†å­¦çš„ã«å¦¥å½“ãªè¨­å®š
2. å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ•´åˆæ€§ç¢ºä¿
3. è‡ªç„¶ã§ä¸€è²«ã—ãŸäººæ ¼è¡¨ç¾
4. æ•™è‚²ãƒ»ç ”ç©¶ç›®çš„ã«é©ã—ãŸå†…å®¹

åå¾©å›æ•°: {iteration}

å®Œå…¨ãªYAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚`;

        const defaultQualityTemplate = `# UPPS ãƒšãƒ«ã‚½ãƒŠå“è³ªè©•ä¾¡

ä»¥ä¸‹ã®ãƒšãƒ«ã‚½ãƒŠãƒ‰ãƒ©ãƒ•ãƒˆã‚’å¤šè§’çš„ã«è©•ä¾¡ã—ã€æ”¹å–„ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## è©•ä¾¡å¯¾è±¡ãƒšãƒ«ã‚½ãƒŠ
\`\`\`yaml
{persona_draft}
\`\`\`

## å…ƒã®åˆ¶ç´„æ¡ä»¶
{constraints}

## è©•ä¾¡åŸºæº–

### 1. åŒ»å­¦çš„å¦¥å½“æ€§ (25ç‚¹)
- ç—‡çŠ¶ãƒ»è¨ºæ–­ã®æ­£ç¢ºæ€§
- ç—…æ­´ãƒ»çµŒéã®æ•´åˆæ€§
- æ²»ç™‚é©å¿œæ€§

### 2. å¿ƒç†å­¦çš„æ•´åˆæ€§ (25ç‚¹)
- BigFiveç‰¹æ€§ã®è«–ç†æ€§
- æ„Ÿæƒ…ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®å¦¥å½“æ€§
- è¨˜æ†¶å†…å®¹ã¨ã®ä¸€è²«æ€§

### 3. UPPSè¦æ ¼æº–æ‹ æ€§ (25ç‚¹)
- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å®Œå…¨æ€§
- ãƒ‡ãƒ¼ã‚¿å‹ãƒ»ç¯„å›²ã®æ­£ç¢ºæ€§
- å‚ç…§æ•´åˆæ€§ï¼ˆIDå‚ç…§ç­‰ï¼‰

### 4. æ•™è‚²çš„ä¾¡å€¤ (25ç‚¹)
- å­¦ç¿’ç›®æ¨™ã¸ã®é©åˆæ€§
- ç¾å®Ÿæ€§ãƒ»ä¿¡æ†‘æ€§
- å¯¾è©±ã§ã®æ´»ç”¨å¯èƒ½æ€§

## å‡ºåŠ›å½¢å¼

**ç·åˆè©•ä¾¡: XXç‚¹**

### å„é …ç›®è©•ä¾¡
- åŒ»å­¦çš„å¦¥å½“æ€§: XX/25ç‚¹
- å¿ƒç†å­¦çš„æ•´åˆæ€§: XX/25ç‚¹  
- UPPSè¦æ ¼æº–æ‹ æ€§: XX/25ç‚¹
- æ•™è‚²çš„ä¾¡å€¤: XX/25ç‚¹

### ä¸»ãªå•é¡Œç‚¹
1. [å…·ä½“çš„ãªå•é¡Œç‚¹]
2. [å…·ä½“çš„ãªå•é¡Œç‚¹]

### æ”¹å–„ææ¡ˆ
1. [å…·ä½“çš„ãªæ”¹å–„æ¡ˆ]
2. [å…·ä½“çš„ãªæ”¹å–„æ¡ˆ]

### å„ªã‚Œã¦ã„ã‚‹ç‚¹
1. [è‰¯ã„ç‚¹]
2. [è‰¯ã„ç‚¹]

ä¸Šè¨˜ã®å½¢å¼ã§å³å¯†ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚`;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadTemplates();
            updateStats();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // è¨­å®šä¿å­˜
        function saveSettings() {
            settings.apiKey = document.getElementById('apiKey').value;
            settings.targetScore = parseInt(document.getElementById('targetScore').value);
            settings.maxIterations = parseInt(document.getElementById('maxIterations').value);
            
            updateStats();
            showAlert('settingsAlert', 'âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿æœ‰åŠ¹ï¼‰', 'success');
        }

        // è¨­å®šèª­ã¿è¾¼ã¿
        function loadSettings() {
            if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
            if (settings.targetScore) document.getElementById('targetScore').value = settings.targetScore;
            if (settings.maxIterations) document.getElementById('maxIterations').value = settings.maxIterations;
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
        function saveTemplates() {
            templates.generation = document.getElementById('generationTemplate').value;
            templates.quality = document.getElementById('qualityTemplate').value;
            
            showAlert('templateAlert', 'âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿æœ‰åŠ¹ï¼‰', 'success');
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        function loadTemplates() {
            document.getElementById('generationTemplate').value = templates.generation || defaultGenerationTemplate;
            document.getElementById('qualityTemplate').value = templates.quality || defaultQualityTemplate;
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ
        function resetTemplates() {
            document.getElementById('generationTemplate').value = defaultGenerationTemplate;
            document.getElementById('qualityTemplate').value = defaultQualityTemplate;
            showAlert('templateAlert', 'ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'info');
        }

        // ã‚µãƒ³ãƒ—ãƒ«CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadSampleCSV() {
            const csvContent = `id,constraints
persona_001,"25æ­³æ—¥æœ¬äººç”·æ€§ã€ç¤¾äº¤ä¸å®‰éšœå®³ã€ITé–¢é€£è·ã€å®Œç’§ä¸»ç¾©çš„å‚¾å‘"
persona_002,"30ä»£å¥³æ€§ã€ã†ã¤ç—…ã€å…ƒçœ‹è­·å¸«ã€2å…ã®æ¯"
persona_003,"40ä»£ç”·æ€§ã€PTSDã€å…ƒè‡ªè¡›å®˜ã€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ä¾å­˜ç—‡ä½µç™º"`;
            
            downloadFile('sample_constraints.csv', csvContent);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                loadCSVContent(files[0]);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function loadCSVFile(event) {
            const file = event.target.files[0];
            if (file) {
                loadCSVContent(file);
            }
        }

        function loadCSVContent(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    if (!headers.includes('id') || !headers.includes('constraints')) {
                        throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ "id" ã¨ "constraints" ã®åˆ—ãŒå¿…è¦ã§ã™');
                    }
                    
                    constraints = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = parseCSVLine(lines[i]);
                            if (values.length >= 2) {
                                constraints.push({
                                    id: values[0].trim().replace(/"/g, ''),
                                    constraints: values[1].trim().replace(/"/g, '')
                                });
                            }
                        }
                    }
                    
                    document.getElementById('fileInfo').innerHTML = `
                        <div class="alert alert-success">
                            âœ… ${constraints.length}ä»¶ã®åˆ¶ç´„æ¡ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ
                        </div>
                    `;
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    let previewHTML = '<h4>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4><div class="code-block">';
                    constraints.slice(0, 5).forEach(c => {
                        previewHTML += `${c.id}: ${c.constraints}\n`;
                    });
                    if (constraints.length > 5) {
                        previewHTML += `... ä»– ${constraints.length - 5} ä»¶`;
                    }
                    previewHTML += '</div>';
                    
                    document.getElementById('csvPreview').innerHTML = previewHTML;
                    updateStats();
                    
                } catch (error) {
                    document.getElementById('fileInfo').innerHTML = `
                        <div class="alert alert-error">
                            âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}
                        </div>
                    `;
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // CSVè¡Œã®ãƒ‘ãƒ¼ã‚¹ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const targetScore = settings.targetScore || 80;
            const maxIterations = settings.maxIterations || 3;
            
            document.getElementById('totalConstraints').textContent = constraints.length;
            document.getElementById('targetScoreDisplay').textContent = targetScore;
            document.getElementById('maxIterDisplay').textContent = maxIterations;
            document.getElementById('estimatedCost').textContent = `${(constraints.length * maxIterations * 2).toFixed(0)}`;
        }

        // ç”Ÿæˆé–‹å§‹
        async function startGeneration() {
            if (!validateGeneration()) return;
            
            isGenerating = true;
            currentIndex = 0;
            results = [];
            
            document.getElementById('generateBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            
            showAlert('generateAlert', 'ğŸš€ ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
            
            for (let i = 0; i < constraints.length && isGenerating; i++) {
                currentIndex = i;
                updateProgress();
                
                try {
                    const result = await processConstraint(constraints[i]);
                    results.push(result);
                    logGeneration(result);
                } catch (error) {
                    const errorResult = {
                        id: constraints[i].id,
                        constraints: constraints[i].constraints,
                        status: 'error',
                        error: error.message,
                        iterations: []
                    };
                    results.push(errorResult);
                    logGeneration(errorResult);
                }
                
                // APIåˆ¶é™å¯¾ç­–ã®é…å»¶
                await sleep(2000);
            }
            
            finishGeneration();
        }

        // ç”Ÿæˆåœæ­¢
        function stopGeneration() {
            isGenerating = false;
            finishGeneration();
        }

        // ç”Ÿæˆå®Œäº†
        function finishGeneration() {
            document.getElementById('generateBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            
            if (isGenerating) {
                showAlert('generateAlert', 'âœ… å…¨ã¦ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            } else {
                showAlert('generateAlert', 'â¹ï¸ ç”Ÿæˆã‚’åœæ­¢ã—ã¾ã—ãŸ', 'warning');
            }
            
            isGenerating = false;
            updateResultsTab();
            showTab('results');
        }

        // å˜ä¸€åˆ¶ç´„æ¡ä»¶ã®å‡¦ç†
        async function processConstraint(constraint) {
            const targetScore = settings.targetScore || 80;
            const maxIterations = settings.maxIterations || 3;
            
            const result = {
                id: constraint.id,
                constraints: constraint.constraints,
                status: 'processing',
                iterations: [],
                finalPersona: null,
                finalScore: 0
            };
            
            let currentDraft = null;
            let improvementSuggestions = '';
            
            for (let iteration = 1; iteration <= maxIterations; iteration++) {
                if (!isGenerating) break;
                
                // ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆ
                let generationPrompt;
                if (iteration === 1) {
                    generationPrompt = document.getElementById('generationTemplate').value
                        .replace('{constraints}', constraint.constraints)
                        .replace('{iteration}', iteration.toString());
                } else {
                    generationPrompt = `åˆ¶ç´„æ¡ä»¶: ${constraint.constraints}

å‰å›ã®ãƒ‰ãƒ©ãƒ•ãƒˆ:
${currentDraft}

æ”¹å–„ææ¡ˆ:
${improvementSuggestions}

ä¸Šè¨˜ã‚’è¸ã¾ãˆã¦æ”¹å–„ã•ã‚ŒãŸUPPS 2025.2æº–æ‹ ãƒšãƒ«ã‚½ãƒŠã‚’YAMLå½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;
                }
                
                const draft = await callOpenAI(generationPrompt, 0.7);
                
                // å“è³ªãƒã‚§ãƒƒã‚¯
                const qualityPrompt = document.getElementById('qualityTemplate').value
                    .replace('{persona_draft}', draft)
                    .replace('{constraints}', constraint.constraints);
                
                const qualityReport = await callOpenAI(qualityPrompt, 0.3);
                const score = extractScore(qualityReport);
                
                const iterationResult = {
                    iteration,
                    draft,
                    qualityReport,
                    score
                };
                
                result.iterations.push(iterationResult);
                
                if (score >= targetScore) {
                    result.status = 'completed';
                    result.finalPersona = draft;
                    result.finalScore = score;
                    break;
                } else {
                    currentDraft = draft;
                    improvementSuggestions = qualityReport;
                }
            }
            
            if (result.status === 'processing') {
                result.status = 'max_iterations_reached';
                result.finalPersona = currentDraft;
                result.finalScore = result.iterations[result.iterations.length - 1]?.score || 0;
            }
            
            return result;
        }

        // OpenAI APIå‘¼ã³å‡ºã—
        async function callOpenAI(prompt, temperature = 0.7) {
            const apiKey = settings.apiKey;
            
            if (!apiKey) {
                throw new Error('OpenAI API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            // æ³¨æ„: ã“ã‚Œã¯å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ CORS ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
            // æœ¬æ¥ã¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo',
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        temperature: temperature,
                        max_tokens: 4000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                // CORS ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
                if (error.message.includes('CORS') || error.name === 'TypeError') {
                    // ãƒ‡ãƒ¢ç”¨ã®æ¨¡æ“¬å¿œç­”
                    return generateMockResponse(prompt, temperature);
                }
                throw error;
            }
        }

        // ãƒ‡ãƒ¢ç”¨æ¨¡æ“¬å¿œç­”ç”Ÿæˆ
        function generateMockResponse(prompt, temperature) {
            if (prompt.includes('å“è³ªè©•ä¾¡')) {
                // å“è³ªè©•ä¾¡ã®æ¨¡æ“¬å¿œç­”
                const score = Math.floor(Math.random() * 40) + 60; // 60-100ç‚¹
                return `**ç·åˆè©•ä¾¡: ${score}ç‚¹**

### å„é …ç›®è©•ä¾¡
- åŒ»å­¦çš„å¦¥å½“æ€§: ${Math.floor(score/4)}/25ç‚¹
- å¿ƒç†å­¦çš„æ•´åˆæ€§: ${Math.floor(score/4)}/25ç‚¹  
- UPPSè¦æ ¼æº–æ‹ æ€§: ${Math.floor(score/4)}/25ç‚¹
- æ•™è‚²çš„ä¾¡å€¤: ${Math.floor(score/4)}/25ç‚¹

### ä¸»ãªå•é¡Œç‚¹
1. æ„Ÿæƒ…ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³å€¤ã®èª¿æ•´ãŒå¿…è¦
2. è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ ã®æ•´åˆæ€§å‘ä¸ŠãŒå¿…è¦

### æ”¹å–„ææ¡ˆ
1. BigFiveç‰¹æ€§å€¤ã®è¦‹ç›´ã—
2. é–¢é€£æ€§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å¼·åŒ–

### å„ªã‚Œã¦ã„ã‚‹ç‚¹
1. åŒ»å­¦çš„è¨­å®šãŒé©åˆ‡
2. èƒŒæ™¯æƒ…å ±ãŒè©³ç´°`;
            } else {
                // ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆã®æ¨¡æ“¬å¿œç­”
                return `personal_info:
  name: "ç”°ä¸­å¤ªéƒ"
  age: 25
  gender: "Male"
  occupation: "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢"
  cultural_background: "æ—¥æœ¬"

background: |
  æ±äº¬éƒ½å†…ã§ç”Ÿã¾ã‚Œè‚²ã¤ã€‚å¹¼å°‘æœŸã‹ã‚‰å†…å‘çš„ã§ã€äººã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è‹¦æ‰‹æ„è­˜ã‚’æŒã£ã¦ã„ã‚‹...

personality:
  model: "BigFive"
  traits:
    openness: 0.6
    conscientiousness: 0.9
    extraversion: 0.2
    agreeableness: 0.7
    neuroticism: 0.8

emotion_system:
  model: "Ekman"
  emotions:
    joy:
      baseline: 40
      description: "å–œã³ã€å¹¸ç¦æ„Ÿ"
    anxiety:
      baseline: 75
      description: "ä¸å®‰ã€å¿ƒé…"

# ... ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ï¼‰`;
            }
        }

        // ã‚¹ã‚³ã‚¢æŠ½å‡º
        function extractScore(qualityReport) {
            const match = qualityReport.match(/ç·åˆè©•ä¾¡[ï¼š:]\s*(\d+)/);
            if (match) {
                return parseInt(match[1]);
            }
            
            const scoreMatch = qualityReport.match(/Score[ï¼š:]?\s*(\d+)/);
            if (scoreMatch) {
                return parseInt(scoreMatch[1]);
            }
            
            return Math.floor(Math.random() * 40) + 60; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }

        // é€²æ—æ›´æ–°
        function updateProgress() {
            const progress = ((currentIndex + 1) / constraints.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressBar').textContent = `${Math.round(progress)}%`;
            document.getElementById('progressText').textContent = 
                `å‡¦ç†ä¸­: ${constraints[currentIndex]?.id} (${currentIndex + 1}/${constraints.length})`;
        }

        // ç”Ÿæˆãƒ­ã‚°
        function logGeneration(result) {
            const logContainer = document.getElementById('generationLog');
            const logItem = document.createElement('div');
            logItem.className = 'result-item';
            
            let statusIcon = 'âœ…';
            let statusClass = 'success';
            if (result.status === 'error') {
                statusIcon = 'âŒ';
                statusClass = 'error';
            } else if (result.status === 'max_iterations_reached') {
                statusIcon = 'âš ï¸';
                statusClass = 'warning';
            }
            
            logItem.innerHTML = `
                <h4>${statusIcon} ${result.id}</h4>
                <p><strong>åˆ¶ç´„æ¡ä»¶:</strong> ${result.constraints}</p>
                <div class="score ${statusClass}">æœ€çµ‚ã‚¹ã‚³ã‚¢: ${result.finalScore || 0}ç‚¹</div>
                <p><strong>åå¾©å›æ•°:</strong> ${result.iterations?.length || 0}å›</p>
                ${result.error ? `<p style="color: #dc3545;"><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${result.error}</p>` : ''}
            `;
            
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // çµæœã‚¿ãƒ–æ›´æ–°
        function updateResultsTab() {
            const completed = results.filter(r => r.status === 'completed').length;
            const partial = results.filter(r => r.status === 'max_iterations_reached').length;
            const errors = results.filter(r => r.status === 'error').length;
            
            document.getElementById('totalProcessed').textContent = results.length;
            document.getElementById('successCount').textContent = completed;
            document.getElementById('partialCount').textContent = partial;
            document.getElementById('errorCount').textContent = errors;
            
            // çµæœãƒªã‚¹ãƒˆè¡¨ç¤º
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                
                let statusIcon = 'âœ…';
                let statusClass = 'success';
                if (result.status === 'error') {
                    statusIcon = 'âŒ';
                    statusClass = 'error';
                } else if (result.status === 'max_iterations_reached') {
                    statusIcon = 'âš ï¸';
                    statusClass = 'warning';
                }
                
                resultDiv.innerHTML = `
                    <h4>${statusIcon} ${result.id}</h4>
                    <p><strong>åˆ¶ç´„æ¡ä»¶:</strong> ${result.constraints}</p>
                    <div class="score ${statusClass}">æœ€çµ‚ã‚¹ã‚³ã‚¢: ${result.finalScore || 0}ç‚¹</div>
                    <p><strong>åå¾©å›æ•°:</strong> ${result.iterations?.length || 0}å›</p>
                    ${result.error ? `<p style="color: #dc3545;"><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${result.error}</p>` : ''}
                    ${result.finalPersona ? `
                        <details>
                            <summary>ç”Ÿæˆã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠã‚’è¡¨ç¤º</summary>
                            <div class="code-block">${result.finalPersona}</div>
                        </details>
                        <button class="btn btn-secondary" onclick="downloadSingleResult('${result.id}')">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    ` : ''}
                `;
                
                resultsList.appendChild(resultDiv);
            });
        }

        // å˜ä¸€çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadSingleResult(resultId) {
            const result = results.find(r => r.id === resultId);
            if (result && result.finalPersona) {
                downloadFile(`${result.id}.yaml`, result.finalPersona);
            }
        }

        // å…¨çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadAllResults() {
            const successfulResults = results.filter(r => r.finalPersona);
            
            if (successfulResults.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªçµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆç°¡æ˜“ç‰ˆï¼šå€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦é †æ¬¡ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
            successfulResults.forEach((result, index) => {
                setTimeout(() => {
                    downloadFile(`${result.id}.yaml`, result.finalPersona);
                }, index * 500); // 0.5ç§’é–“éš”ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            });
        }

        // ã‚µãƒãƒªãƒ¼CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadSummaryCSV() {
            if (results.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªçµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let csvContent = 'id,constraints,status,final_score,iterations,error\n';
            
            results.forEach(result => {
                const escapedConstraints = `"${result.constraints.replace(/"/g, '""')}"`;
                const error = result.error ? `"${result.error.replace(/"/g, '""')}"` : '';
                
                csvContent += `${result.id},${escapedConstraints},${result.status},${result.finalScore || 0},${result.iterations?.length || 0},${error}\n`;
            });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            downloadFile(`generation_summary_${timestamp}.csv`, csvContent);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateGeneration() {
            if (!settings.apiKey) {
                showAlert('generateAlert', 'âŒ OpenAI API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                showTab('setup');
                return false;
            }
            
            if (constraints.length === 0) {
                showAlert('generateAlert', 'âŒ åˆ¶ç´„æ¡ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                showTab('files');
                return false;
            }
            
            return true;
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // ã‚¹ãƒªãƒ¼ãƒ—é–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>